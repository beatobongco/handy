<!DOCTYPE html>
<html>
<head>
  <title>Handy: read handwritten digits with AI - beatobongco.com</title>
  <style type="text/css">
    canvas {
      border: 1px solid black;
      margin-right: 10px;
    }
    .noselect {
      -webkit-touch-callout: none; /* iOS Safari */
        -webkit-user-select: none; /* Safari */
         -khtml-user-select: none; /* Konqueror HTML */
           -moz-user-select: none; /* Firefox */
            -ms-user-select: none; /* Internet Explorer/Edge */
                user-select: none; /* Non-prefixed version, currently
                                      supported by Chrome and Opera */
    }
  </style>
</head>
<body>
  <h1>Handy</h1>
  <h3>Draw here!</h3>
  <p>
    <small>The smaller box is the actual image passed to the AI model.</small>
  </p>
  <div>
    <canvas class="noselect" id="drawing-canvas" width="280" height="280"></canvas>
    <canvas class="noselect" id="resized-drawing" width="28" height="28"></canvas>
  </div>
  <div>
    <button id="clear">Clear</button>
    <button id="readDrawing">Read</button>
  </div>
  <p id="message"></p>
<script src="https://cdnjs.cloudflare.com/ajax/libs/numjs/0.16.0/numjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tensorflow/0.11.7/tf.min.js"></script>
<script>
  // our keras model
  let model = null

  // tells us whether we are allowed to draw on canvas
  let paint = null

  let results = []

  // canvas vars
  let resizedCnv = document.getElementById('resized-drawing')
  let resizedCtx = resizedCnv.getContext('2d')
  let drawingCnv = document.getElementById('drawing-canvas')
  let drawingCtx = drawingCnv.getContext('2d')

  drawingCtx.fillStyle = '#000'
  resizedCtx.fillStyle = '#000'
  drawingCtx.strokeStyle = '#fff'
  drawingCtx.lineJoin = 'round'
  drawingCtx.lineWidth = 10

  // our drawing canvas' state
  let clickX = []
  let clickY = []
  let clickDrag = []

  function setMessage(msg) {
    document.getElementById('message').innerHTML = msg
  }

  function clearCanvas(ctx) {
    ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height)
    ctx.fillRect(0, 0, ctx.canvas.width, ctx.canvas.height)
  }

  function predictImage(image) {
    // first, reshape the image
    // format for shape is [n_images, x_shape, y_shape, n_steps::channels?]
    // src: https://stackoverflow.com/questions/43895750/keras-input-shape-for-conv2d-and-manually-loaded-images
    reshapedImage = image.reshape([1, 28, 28, 1])

    // then create a tensor, which our model expects
    _tensor = tf.tensor(reshapedImage.selection.data, [1, 28, 28, 1])

    // gives an array of len num_classes
    model.predict(_tensor).data().then(function(predVector) {
      // loop over and check which is 1, that's your class
      for (var i = 0; i < predVector.length; i++) {
        if (predVector[i]) {
          results.push(i)
          setMessage('Handy sees a ' + i)
        }
      }
    })
  }

  function loadImage(src) {
    let img = new Image()
    img.src = src
    img.crossOrigin = 'Anonymous'

    img.onload = function() {
      // resize first if not correct dims
      if (this.width !== 28 || this.height !== 28) {
        clearCanvas(resizedCtx)
        resizedCtx.drawImage(img, 0, 0, 28, 28)

        loadImage(resizedCnv.toDataURL('image/jpeg'))
      } else {
        predictImage(nj.images.read(img))
      }
    }
  }

  function addClick(x, y, dragging) {
    clickX.push(x)
    clickY.push(y)
    clickDrag.push(dragging)
  }

  function redraw() {
    // clear canvas
    clearCanvas(drawingCtx)

    for (var i = 0; i < clickX.length; i++) {
      drawingCtx.beginPath()
      // dont activate on i = 0
      if (clickDrag[i] && i) {
        drawingCtx.moveTo(clickX[i - 1], clickY[i - 1])
      } else {
        drawingCtx.moveTo(clickX[i] - 1, clickY[i])
      }
      drawingCtx.lineTo(clickX[i] - 1, clickY[i])
      drawingCtx.closePath()
      drawingCtx.stroke()
    }
  }

  drawingCnv.addEventListener('mousedown', function(e) {
    var mouseX = e.pageX - this.offsetLeft
    var mouseY = e.pageY - this.offsetTop

    paint = true
    addClick(mouseX, mouseY)
    redraw()
  })

  drawingCnv.addEventListener('mousemove', function(e) {
    if (paint) {
      var mouseX = e.pageX - this.offsetLeft
      var mouseY = e.pageY - this.offsetTop
      addClick(mouseX, mouseY, true)
      redraw()
    }
  })

  drawingCnv.addEventListener('mouseleave', function(e) {
    paint = false
  })

  drawingCnv.addEventListener('mouseup', function(e) {
    paint = false
  })

  function clearAllCanvas() {
    clickX = []
    clickY = []
    clickDrag = []
    clearCanvas(drawingCtx)
    clearCanvas(resizedCtx)
  }

  document.getElementById('clear').addEventListener('click', clearAllCanvas)

  document.getElementById('readDrawing').addEventListener('click', function() {
    loadImage(drawingCnv.toDataURL('image/png'))
  })

  tf.loadModel('https://beatobongco.com/handy/tfjs_artifacts/model.json').then(function(res) {
    model = res
    setMessage('Model loaded')
  })

  clearAllCanvas()
</script>
</body>
</html>
